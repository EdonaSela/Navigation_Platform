name: ci-cd

on:
  pull_request:
  push:
    branches:
      - main
      - master

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/navigation-platform

jobs:
  build-test-analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Restore
        run: dotnet restore NavigationPlatform.sln

      - name: Build
        run: dotnet build NavigationPlatform.sln --configuration Release --no-restore

      - name: Backend tests with coverage gate (>=80%)
        run: >
          dotnet test tests/JourneyService.Api.Tests/JourneyService.Api.Tests.csproj
          --configuration Release
          --no-build
          /p:CollectCoverage=true
          /p:CoverletOutput=./TestResults/Coverage/
          /p:CoverletOutputFormat=cobertura
          /p:Threshold=80
          /p:ThresholdType=line
          /p:ThresholdStat=total

      - name: Build with analyzers (capture warnings)
        shell: bash
        run: |
          set -o pipefail
          dotnet build NavigationPlatform.sln \
            --configuration Release \
            --no-restore \
            /p:RunAnalyzersDuringBuild=true \
            /p:EnableNETAnalyzers=true \
            /p:TreatWarningsAsErrors=false 2>&1 | tee analyzer-build.log

      - name: Analyzer gate (fail only on new warnings)
        shell: pwsh
        run: ./scripts/ci-analyzer-gate.ps1 -BuildLogPath analyzer-build.log -BaselinePath .ci/analyzer-baseline.txt

      - name: Frontend install
        working-directory: frontend
        run: npm ci

      - name: Frontend tests with coverage
        working-directory: frontend
        run: npm run test:coverage -- --watch=false

      - name: Frontend coverage gate (>=80%)
        shell: bash
        run: |
          set -euo pipefail
          lcov_file="$(find frontend/coverage -name lcov.info -print -quit)"
          if [ -z "${lcov_file:-}" ]; then
            echo "lcov.info not found under frontend/coverage"
            exit 1
          fi

          lines_found=$(awk -F: '/^LF:/{sum+=$2} END{print sum+0}' "$lcov_file")
          lines_hit=$(awk -F: '/^LH:/{sum+=$2} END{print sum+0}' "$lcov_file")
          if [ "$lines_found" -eq 0 ]; then
            echo "No lines found in coverage report"
            exit 1
          fi

          coverage=$((100 * lines_hit / lines_found))
          echo "Frontend line coverage: ${coverage}%"
          if [ "$coverage" -lt 80 ]; then
            echo "Frontend coverage is below 80%"
            exit 1
          fi

      - name: Login to GHCR
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/JourneyService.Api/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-api:${{ github.sha }}

      - name: Build and push RewardWorker image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: src/RewardWorker/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-rewardworker:${{ github.sha }}

      - name: Build and push Frontend image
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-frontend:${{ github.sha }}

      - name: Spin up stack
        run: docker compose up -d --build

      - name: Wait for API readiness
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..30}; do
            if curl -fsS http://localhost:5000/readyz >/dev/null; then
              echo "API is ready"
              exit 0
            fi
            sleep 5
          done
          echo "API was not ready in time"
          docker compose ps
          docker compose logs api --tail=200 || true
          exit 1

      - name: Run integration tests
        run: >
          dotnet test tests/JourneyService.Api.Tests/JourneyService.Api.Tests.csproj
          --configuration Release
          --no-build
          --filter FullyQualifiedName~JourneyIntegrationTests

      - name: Tear down stack
        if: always()
        run: docker compose down -v
